# å¤šç§Ÿæˆ·æ¶æ„æ–¹æ¡ˆæ€»ç»“

## âœ… å¯è¡Œæ€§ç»“è®º

**ä½œä¸ºèµ„æ·±å·¥ç¨‹å¸ˆï¼Œæˆ‘ç¡®è®¤ï¼šè¿™ä¸ªæ–¹æ¡ˆæ˜¯å®Œå…¨å¯è¡Œçš„ï¼Œä¸”æ˜¯æ›´ä¼˜çš„æ¶æ„é€‰æ‹©ã€‚**

---

## ğŸ¯ æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ A: æ¯ä¸ªå…¬å¸ç‹¬ç«‹éƒ¨ç½²ï¼ˆåŸæ–¹æ¡ˆï¼‰

```
chatbot-service/
â”œâ”€â”€ goldenyears/          â†’ ç‹¬ç«‹éƒ¨ç½²
â”œâ”€â”€ company2/             â†’ ç‹¬ç«‹éƒ¨ç½²
â””â”€â”€ company3/             â†’ ç‹¬ç«‹éƒ¨ç½²
```

**ç¼ºç‚¹**:
- âŒ éœ€è¦å¤šæ¬¡éƒ¨ç½²
- âŒ ä»£ç æ›´æ–°éœ€è¦åŒæ­¥å¤šä¸ªé¡¹ç›®
- âŒ ç»´æŠ¤æˆæœ¬é«˜
- âŒ èµ„æºæµªè´¹ï¼ˆå¤šä¸ª Cloudflare Pages é¡¹ç›®ï¼‰

### æ–¹æ¡ˆ B: å•ä¸€éƒ¨ç½²ï¼Œå¤šç§Ÿæˆ·ï¼ˆæ¨èæ–¹æ¡ˆï¼‰âœ¨

```
chatbot-service/
â”œâ”€â”€ functions/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ [company]/    â†’ åŠ¨æ€è·¯ç”±
â”œâ”€â”€ knowledge/
â”‚   â”œâ”€â”€ goldenyears/      â†’ å…¬å¸ç‰¹å®šçŸ¥è¯†åº“
â”‚   â”œâ”€â”€ company2/         â†’ å…¬å¸ç‰¹å®šçŸ¥è¯†åº“
â”‚   â””â”€â”€ companies.json    â†’ å…¬å¸é…ç½®
â””â”€â”€ widget/               â†’ å…±äº« Widget
```

**ä¼˜ç‚¹**:
- âœ… åªéœ€éƒ¨ç½²ä¸€æ¬¡
- âœ… ä»£ç æ›´æ–°åªéœ€ä¸€æ¬¡
- âœ… ç»´æŠ¤æˆæœ¬ä½
- âœ… èµ„æºé«˜æ•ˆ
- âœ… æ˜“äºæ‰©å±•æ–°å…¬å¸

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### è·¯ç”±è®¾è®¡

```
/api/goldenyears/chat          â†’ å¥½æ™‚æœ‰å½±èŠå¤©
/api/goldenyears/faq-menu      â†’ å¥½æ™‚æœ‰å½± FAQ
/api/company2/chat              â†’ å…¬å¸ 2 èŠå¤©
/api/company2/faq-menu          â†’ å…¬å¸ 2 FAQ
```

**å®ç°æ–¹å¼**: Cloudflare Pages Functions åŠ¨æ€è·¯ç”± `[company]`

### çŸ¥è¯†åº“éš”ç¦»

```
knowledge/
â”œâ”€â”€ goldenyears/
â”‚   â”œâ”€â”€ services.json
â”‚   â”œâ”€â”€ faq_detailed.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ company2/
â”‚   â”œâ”€â”€ services.json
â”‚   â””â”€â”€ ...
â””â”€â”€ companies.json          # å…¬å¸é…ç½®
```

### Widget ä½¿ç”¨

```html
<!-- å¥½æ™‚æœ‰å½± -->
<script 
  src="https://chatbot-api.example.com/widget/loader.js" 
  data-company="goldenyears"
  data-api-endpoint="https://chatbot-api.example.com/api/goldenyears/chat"
  defer
></script>

<!-- å…¬å¸ 2 -->
<script 
  src="https://chatbot-api.example.com/widget/loader.js" 
  data-company="company2"
  data-api-endpoint="https://chatbot-api.example.com/api/company2/chat"
  defer
></script>
```

---

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. Cloudflare Pages Functions åŠ¨æ€è·¯ç”±

Cloudflare Pages Functions æ”¯æŒåŠ¨æ€è·¯ç”±ï¼š

```
functions/
â””â”€â”€ api/
    â””â”€â”€ [company]/
        â”œâ”€â”€ chat.ts
        â””â”€â”€ faq-menu.ts
```

`[company]` ä¼šè¢«è§£æä¸ºè·¯å¾„å‚æ•°ï¼Œä¾‹å¦‚ï¼š
- `/api/goldenyears/chat` â†’ `params.company = "goldenyears"`

### 2. çŸ¥è¯†åº“åŠ è½½

```typescript
// æ ¹æ®å…¬å¸ ID åŠ è½½å¯¹åº”çš„çŸ¥è¯†åº“
const knowledgeBase = await loadCompanyKnowledgeBase(companyId, request);
// åŠ è½½: /knowledge/{companyId}/services.json
```

### 3. é…ç½®ç®¡ç†

```json
// knowledge/companies.json
{
  "goldenyears": {
    "allowedOrigins": ["https://www.goldenyearsphoto.com"],
    "widgetConfig": { "theme": "light" }
  }
}
```

### 4. ä¸Šä¸‹æ–‡éš”ç¦»

```typescript
// ä½¿ç”¨ companyId:conversationId ä½œä¸º key
const contextKey = `${companyId}:${conversationId}`;
```

---

## ğŸ“Š ä¼˜åŠ¿åˆ†æ

### 1. éƒ¨ç½²ä¼˜åŠ¿

| é¡¹ç›® | ç‹¬ç«‹éƒ¨ç½² | å¤šç§Ÿæˆ· |
|------|---------|--------|
| éƒ¨ç½²æ¬¡æ•° | N æ¬¡ï¼ˆN = å…¬å¸æ•°ï¼‰ | 1 æ¬¡ |
| éƒ¨ç½²æ—¶é—´ | N Ã— éƒ¨ç½²æ—¶é—´ | 1 Ã— éƒ¨ç½²æ—¶é—´ |
| éƒ¨ç½²å¤æ‚åº¦ | é«˜ | ä½ |

### 2. ç»´æŠ¤ä¼˜åŠ¿

| é¡¹ç›® | ç‹¬ç«‹éƒ¨ç½² | å¤šç§Ÿæˆ· |
|------|---------|--------|
| ä»£ç æ›´æ–° | éœ€è¦æ›´æ–° N ä¸ªé¡¹ç›® | æ›´æ–° 1 æ¬¡ |
| Bug ä¿®å¤ | éœ€è¦ä¿®å¤ N æ¬¡ | ä¿®å¤ 1 æ¬¡ |
| åŠŸèƒ½æ·»åŠ  | éœ€è¦æ·»åŠ  N æ¬¡ | æ·»åŠ  1 æ¬¡ |

### 3. æˆæœ¬ä¼˜åŠ¿

| é¡¹ç›® | ç‹¬ç«‹éƒ¨ç½² | å¤šç§Ÿæˆ· |
|------|---------|--------|
| Cloudflare Pages é¡¹ç›®æ•° | N ä¸ª | 1 ä¸ª |
| èµ„æºä½¿ç”¨ | N Ã— åŸºç¡€èµ„æº | 1 Ã— åŸºç¡€èµ„æº |
| ç›‘æ§å¤æ‚åº¦ | N ä¸ªç›‘æ§ | 1 ä¸ªç›‘æ§ |

### 4. æ‰©å±•ä¼˜åŠ¿

**æ·»åŠ æ–°å…¬å¸**:

- **ç‹¬ç«‹éƒ¨ç½²**: éœ€è¦åˆ›å»ºæ–°é¡¹ç›®ã€é…ç½®ã€éƒ¨ç½²ï¼ˆ1-2 å°æ—¶ï¼‰
- **å¤šç§Ÿæˆ·**: åªéœ€æ·»åŠ çŸ¥è¯†åº“ç›®å½•å’Œé…ç½®ï¼ˆ10-15 åˆ†é’Ÿï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å®‰å…¨æ€§

- âœ… **å…¬å¸ ID éªŒè¯**: å¿…é¡»éªŒè¯å…¬å¸ ID çš„æœ‰æ•ˆæ€§
- âœ… **CORS éš”ç¦»**: æ¯ä¸ªå…¬å¸ç‹¬ç«‹çš„ CORS é…ç½®
- âœ… **ä¸Šä¸‹æ–‡éš”ç¦»**: ä½¿ç”¨ `companyId:conversationId` ç¡®ä¿éš”ç¦»

### 2. æ€§èƒ½

- âœ… **çŸ¥è¯†åº“ç¼“å­˜**: æ¯ä¸ªå…¬å¸çš„çŸ¥è¯†åº“ç‹¬ç«‹ç¼“å­˜
- âœ… **å¹¶å‘å¤„ç†**: å¤šç§Ÿæˆ·ä¸ä¼šç›¸äº’å½±å“
- âœ… **èµ„æºé™åˆ¶**: Cloudflare Pages Functions æœ‰èµ„æºé™åˆ¶ï¼Œä½†é€šå¸¸è¶³å¤Ÿ

### 3. ç›‘æ§

- âœ… **æ—¥å¿—æ ‡è¯†**: æ¯æ¡æ—¥å¿—åŒ…å« `companyId`
- âœ… **æŒ‡æ ‡ç»Ÿè®¡**: å¯ä»¥æŒ‰å…¬å¸åˆ†åˆ«ç»Ÿè®¡
- âœ… **é”™è¯¯è¿½è¸ª**: é”™è¯¯æ—¥å¿—åŒ…å«å…¬å¸ä¿¡æ¯

---

## ğŸš€ å®æ–½å»ºè®®

### é˜¶æ®µ 1: å‡†å¤‡ï¼ˆ1-2 å¤©ï¼‰

1. åˆ›å»ºæ–°çš„ç›®å½•ç»“æ„
2. åˆ›å»ºå…¬å¸é…ç½®æ–‡ä»¶
3. è®¾è®¡è·¯ç”±æ–¹æ¡ˆ

### é˜¶æ®µ 2: ä»£ç é‡æ„ï¼ˆ3-5 å¤©ï¼‰

1. åˆ›å»ºåŠ¨æ€è·¯ç”± `functions/api/[company]/`
2. ä¿®æ”¹çŸ¥è¯†åº“åŠ è½½å™¨æ”¯æŒå¤šç§Ÿæˆ·
3. ä¿®æ”¹é…ç½®ç®¡ç†
4. ä¿®æ”¹ Widget æ”¯æŒ `data-company`

### é˜¶æ®µ 3: æµ‹è¯•ï¼ˆ2-3 å¤©ï¼‰

1. å•å…ƒæµ‹è¯•
2. é›†æˆæµ‹è¯•
3. å¤šç§Ÿæˆ·éš”ç¦»æµ‹è¯•

### é˜¶æ®µ 4: éƒ¨ç½²ï¼ˆ1 å¤©ï¼‰

1. éƒ¨ç½²åˆ° Cloudflare Pages
2. æ›´æ–° goldenyearsphoto ç½‘ç«™
3. éªŒè¯åŠŸèƒ½

---

## ğŸ“ è¿ç§»æ­¥éª¤ï¼ˆç®€åŒ–ç‰ˆï¼‰

### æ­¥éª¤ 1: é‡æ„ç›®å½•

```bash
cd /Users/jackm4/Documents/GitHub/chatbot-service

# åˆ›å»ºæ–°ç»“æ„
mkdir -p knowledge/goldenyears
mkdir -p functions/api/\[company\]

# ç§»åŠ¨çŸ¥è¯†åº“
mv goldenyears/knowledge/* knowledge/goldenyears/
```

### æ­¥éª¤ 2: åˆ›å»ºåŠ¨æ€è·¯ç”±

åˆ›å»º `functions/api/[company]/chat.ts` å’Œ `faq-menu.ts`

### æ­¥éª¤ 3: åˆ›å»ºå…¬å¸é…ç½®

åˆ›å»º `knowledge/companies.json`

### æ­¥éª¤ 4: æ›´æ–° Widget

ä¿®æ”¹ `widget/loader.js` æ”¯æŒ `data-company`

### æ­¥éª¤ 5: æ›´æ–°ç½‘ç«™

æ›´æ–° `goldenyearsphoto` çš„ `base-layout.njk`

---

## âœ… æœ€ç»ˆç»“è®º

### å¯è¡Œæ€§: âœ… **å®Œå…¨å¯è¡Œ**

### æ¨èåº¦: â­â­â­â­â­ **å¼ºçƒˆæ¨è**

### ç†ç”±:

1. **æŠ€æœ¯æˆç†Ÿ**: Cloudflare Pages Functions å®Œå…¨æ”¯æŒåŠ¨æ€è·¯ç”±
2. **æ¶æ„æ¸…æ™°**: å¤šç§Ÿæˆ·æ˜¯ SaaS çš„æ ‡å‡†æ¶æ„
3. **ç»´æŠ¤ç®€å•**: å•ä¸€ä»£ç åº“ï¼Œæ˜“äºç»´æŠ¤
4. **æ‰©å±•å®¹æ˜“**: æ·»åŠ æ–°å…¬å¸åªéœ€é…ç½®
5. **æˆæœ¬æ•ˆç›Š**: èµ„æºä½¿ç”¨æ›´é«˜æ•ˆ

### å»ºè®®:

**ç«‹å³é‡‡ç”¨å¤šç§Ÿæˆ·æ¶æ„**ï¼Œè¿™æ˜¯æ›´ä¼˜çš„é•¿æœŸæ–¹æ¡ˆã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **[MULTI_TENANT_ARCHITECTURE.md](./MULTI_TENANT_ARCHITECTURE.md)** - è¯¦ç»†æ¶æ„è®¾è®¡
- **[MULTI_TENANT_IMPLEMENTATION.md](./MULTI_TENANT_IMPLEMENTATION.md)** - å®æ–½æŒ‡å—

---

**æœ€åæ›´æ–°**: 2024-01-XX  
**å®¡æ ¸**: èµ„æ·±å·¥ç¨‹å¸ˆ âœ…
