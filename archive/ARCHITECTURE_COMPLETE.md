# ğŸ—ï¸ chatbot-service å®Œæ•´æ¶æ„æ–‡æ¡£

**ç‰ˆæœ¬**: 3.0  
**æœ€åæ›´æ–°**: 2025-12-10

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ•°æ®æµ](#æ•°æ®æµ)
5. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
6. [å®‰å…¨æ€§](#å®‰å…¨æ€§)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
8. [ç›‘æ§å’Œè¿ç»´](#ç›‘æ§å’Œè¿ç»´)
9. [æ‰©å±•æ€§](#æ‰©å±•æ€§)
10. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ç³»ç»Ÿæ¦‚è¿°

### é¡¹ç›®å®šä½

chatbot-service æ˜¯ä¸€ä¸ª**ä¼ä¸šçº§å¤šç§Ÿæˆ· AI èŠå¤©æœºå™¨äººæœåŠ¡å¹³å°**ï¼Œé‡‡ç”¨äº‘åŸç”Ÿæ¶æ„ï¼Œä¸ºå¤šä¸ªå…¬å¸æä¾›æ™ºèƒ½å®¢æœè§£å†³æ–¹æ¡ˆã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å¤šç§Ÿæˆ·æ¶æ„**: å•å®ä¾‹æ”¯æŒå¤šä¸ªå…¬å¸ï¼Œæ•°æ®å®Œå…¨éš”ç¦»
- âœ… **Pipeline v3 å¼•æ“**: å¯è§†åŒ–å·¥ä½œæµï¼Œçµæ´»æ‰©å±•
- âœ… **äº‘åŸç”Ÿéƒ¨ç½²**: Cloudflare Pages + D1 + Workers
- âœ… **ä¼ä¸šçº§è´¨é‡**: å®Œæ•´æµ‹è¯•ã€ç›‘æ§ã€æ–‡æ¡£
- âœ… **AI é©±åŠ¨**: Google Gemini æä¾›æ™ºèƒ½å¯¹è¯èƒ½åŠ›

### æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å‰ç«¯ (Widget)                    â”‚
â”‚  HTML + CSS + Vanilla JavaScript        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         API å±‚ (Cloudflare Pages)       â”‚
â”‚  TypeScript + Cloudflare Functions      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Pipeline v3 å¼•æ“                 â”‚
â”‚  å·¥ä½œæµç¼–æ’ + èŠ‚ç‚¹æ‰§è¡Œ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare D1â”‚  Google      â”‚ Knowledge â”‚
â”‚  (æ•°æ®åº“)    â”‚  Gemini API  â”‚   Base    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¶æ„è®¾è®¡

### 1. å¤šç§Ÿæˆ·æ¶æ„

```
ç”¨æˆ·è¯·æ±‚æµç¨‹:

1. Widget åŠ è½½
   https://chatbot-service.pages.dev/widget/loader.js
   â†“ data-company="goldenyears"
   
2. API è·¯ç”±
   /api/[company]/chat
   â†“ åŠ¨æ€è·¯ç”±å‚æ•°
   
3. å…¬å¸é…ç½®åŠ è½½
   knowledge/companies.json
   â†“ éªŒè¯ã€åŠ è½½çŸ¥è¯†åº“
   
4. Pipeline æ‰§è¡Œ
   WorkflowEngine.execute()
   â†“ èŠ‚ç‚¹é“¾å¼å¤„ç†
   
5. è¿”å›å“åº”
   JSON response
```

#### ç§Ÿæˆ·éš”ç¦»æœºåˆ¶

| éš”ç¦»å±‚é¢ | å®ç°æ–¹å¼ | è¯´æ˜ |
|---------|---------|------|
| **è·¯ç”±éš”ç¦»** | `/api/[company]/` | URL çº§åˆ«éš”ç¦» |
| **é…ç½®éš”ç¦»** | `companies.json` | ç‹¬ç«‹é…ç½®æ–‡ä»¶ |
| **çŸ¥è¯†åº“éš”ç¦»** | `knowledge/{company}/` | ç›®å½•çº§åˆ«éš”ç¦» |
| **æ•°æ®éš”ç¦»** | `company_id` å­—æ®µ | æ•°æ®åº“çº§åˆ«éš”ç¦» |
| **CORS éš”ç¦»** | `allowedOrigins` | æ¥æºç™½åå• |

### 2. Pipeline v3 æ¶æ„

```
Pipeline v3 = å·¥ä½œæµå¼•æ“ + å¯ç»„åˆèŠ‚ç‚¹

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         WorkflowEngine                   â”‚
â”‚  â€¢ åŠ è½½å·¥ä½œæµå®šä¹‰                         â”‚
â”‚  â€¢ ç®¡ç†èŠ‚ç‚¹æ³¨å†Œè¡¨                         â”‚
â”‚  â€¢ æ‰§è¡ŒèŠ‚ç‚¹é“¾                            â”‚
â”‚  â€¢ é”™è¯¯å¤„ç†å’Œè·¯ç”±                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ExecutionContext                 â”‚
â”‚  â€¢ å…±äº«æ•°æ®å­˜å‚¨                           â”‚
â”‚  â€¢ æ‰§è¡Œè¿½è¸ª                              â”‚
â”‚  â€¢ æ€§èƒ½ç›‘æ§                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validate â”‚ Context  â”‚   LLM    â”‚Responseâ”‚
â”‚   Node   â”‚   Node   â”‚   Node   â”‚  Node  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒæ¦‚å¿µ

1. **BaseNode (åŸºç¡€èŠ‚ç‚¹)**
   - æ‰€æœ‰èŠ‚ç‚¹çš„æŠ½è±¡åŸºç±»
   - å®šä¹‰æ ‡å‡†æ¥å£ (`execute`)
   - å…ƒæ•°æ®ç®¡ç†

2. **WorkflowDefinition (å·¥ä½œæµå®šä¹‰)**
   - JSON æ ¼å¼
   - å£°æ˜å¼é…ç½®
   - ç‰ˆæœ¬æ§åˆ¶

3. **ExecutionContext (æ‰§è¡Œä¸Šä¸‹æ–‡)**
   - èŠ‚ç‚¹é—´æ•°æ®å…±äº«
   - æ‰§è¡Œå†å²è¿½è¸ª
   - æ€§èƒ½æŒ‡æ ‡è®°å½•

4. **NodeRegistry (èŠ‚ç‚¹æ³¨å†Œè¡¨)**
   - åŠ¨æ€èŠ‚ç‚¹æ³¨å†Œ
   - æŒ‰éœ€åŠ è½½
   - ç‰ˆæœ¬ç®¡ç†

### 3. åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¡¨ç°å±‚ (Presentation Layer)              â”‚
â”‚  â€¢ Widget UI                              â”‚
â”‚  â€¢ Admin Dashboard                        â”‚
â”‚  â€¢ Demo Pages                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API å±‚ (API Layer)                       â”‚
â”‚  â€¢ REST Endpoints                         â”‚
â”‚  â€¢ CORS Handling                          â”‚
â”‚  â€¢ Request Validation                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)         â”‚
â”‚  â€¢ Pipeline v3 Engine                     â”‚
â”‚  â€¢ Company Config                         â”‚
â”‚  â€¢ Context Management                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®è®¿é—®å±‚ (Data Access Layer)            â”‚
â”‚  â€¢ DatabaseManager                        â”‚
â”‚  â€¢ KnowledgeBase                          â”‚
â”‚  â€¢ AnalyticsService                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)         â”‚
â”‚  â€¢ Cloudflare D1                          â”‚
â”‚  â€¢ Cloudflare Workers                     â”‚
â”‚  â€¢ Google Gemini API                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” |
|------|------|------|
| `/api/[company]/chat` | POST | èŠå¤©æ¶ˆæ¯å¤„ç† |
| `/api/[company]/faq-menu` | GET | è·å– FAQ èœå• |
| `/api/workflows/[id]` | GET | è·å–å·¥ä½œæµå®šä¹‰ |
| `/api/analytics/stats` | GET | è·å–ç»Ÿè®¡æ•°æ® |
| `/scheduled` | POST | å®šæ—¶ä»»åŠ¡è§¦å‘ |

### 2. Pipeline èŠ‚ç‚¹

#### æ ¸å¿ƒèŠ‚ç‚¹ (Core Nodes)

```typescript
1. ValidateNode        // è¯·æ±‚éªŒè¯
2. InitializeNode      // æœåŠ¡åˆå§‹åŒ–
3. ContextNode         // ä¸Šä¸‹æ–‡ç®¡ç†
4. IntentNode          // æ„å›¾è¯†åˆ«
5. StateTransitionNode // çŠ¶æ€è½¬æ¢
6. SpecialIntentNode   // ç‰¹æ®Šæ„å›¾å¤„ç†
7. FAQNode             // FAQ æ£€æŸ¥
8. LLMNode             // LLM ç”Ÿæˆ
9. ResponseNode        // å“åº”æ„å»º
```

#### èŠ‚ç‚¹è®¾è®¡åŸåˆ™

- **å•ä¸€èŒè´£**: æ¯ä¸ªèŠ‚ç‚¹åªåšä¸€ä»¶äº‹
- **å¯ç»„åˆ**: èŠ‚ç‚¹å¯ä»¥çµæ´»ç»„åˆ
- **å¯æµ‹è¯•**: æ¯ä¸ªèŠ‚ç‚¹ç‹¬ç«‹æµ‹è¯•
- **å¯è§‚æµ‹**: å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—

### 3. æ•°æ®ç®¡ç†

#### æ•°æ®æ¨¡å‹ (7å¼ è¡¨)

```sql
conversations       -- ä¼šè¯è®°å½•
messages            -- æ¶ˆæ¯è®°å½•
users               -- ç”¨æˆ·ä¿¡æ¯
performance_metrics -- æ€§èƒ½æŒ‡æ ‡
workflow_executions -- å·¥ä½œæµæ‰§è¡Œ
faq_queries         -- FAQ æŸ¥è¯¢
intent_statistics   -- æ„å›¾ç»Ÿè®¡
```

#### æ•°æ®è®¿é—®å±‚

```typescript
DatabaseManager      // æ•°æ®åº“æ“ä½œ
AnalyticsService     // æ•°æ®åˆ†æ
TaskScheduler        // ä»»åŠ¡è°ƒåº¦
```

### 4. çŸ¥è¯†åº“ç³»ç»Ÿ

```
knowledge/
â”œâ”€â”€ companies.json              -- å…¬å¸é…ç½®
â””â”€â”€ {companyId}/
    â”œâ”€â”€ services.json           -- æœåŠ¡ä¿¡æ¯
    â”œâ”€â”€ faq_detailed.json       -- FAQ è¯¦æƒ…
    â”œâ”€â”€ greeting.json           -- é—®å€™è¯­
    â”œâ”€â”€ quick_replies.json      -- å¿«æ·å›å¤
    â””â”€â”€ context_rules.json      -- ä¸Šä¸‹æ–‡è§„åˆ™
```

---

## æ•°æ®æµ

### å®Œæ•´çš„è¯·æ±‚-å“åº”æµç¨‹

```
1. ç”¨æˆ·å‘é€æ¶ˆæ¯
   â†“
2. Widget å‘é€ POST è¯·æ±‚
   /api/goldenyears/chat
   {
     message: "ä½ å¥½",
     conversationId: "conv_123"
   }
   â†“
3. API ç«¯ç‚¹æ¥æ”¶
   - CORS éªŒè¯
   - è¯·æ±‚éªŒè¯
   - åŠ è½½å…¬å¸é…ç½®
   â†“
4. Pipeline æ‰§è¡Œ (9ä¸ªèŠ‚ç‚¹)
   â†“
   [ValidateNode]
   â”œâ”€ éªŒè¯æ¶ˆæ¯å†…å®¹
   â”œâ”€ éªŒè¯ä¼šè¯ ID
   â””â”€ è®¾ç½® CORS å¤´
   â†“
   [InitializeNode]
   â”œâ”€ åŠ è½½çŸ¥è¯†åº“
   â”œâ”€ åˆå§‹åŒ– LLM
   â””â”€ åŠ è½½ä¸Šä¸‹æ–‡ç®¡ç†å™¨
   â†“
   [ContextNode]
   â”œâ”€ åŠ è½½ä¼šè¯å†å²
   â”œâ”€ æ›´æ–°ä¸Šä¸‹æ–‡
   â””â”€ è¿½è¸ªä¼šè¯çŠ¶æ€
   â†“
   [IntentNode]
   â”œâ”€ åˆ†æç”¨æˆ·æ„å›¾
   â”œâ”€ æå–å®ä½“
   â””â”€ ç½®ä¿¡åº¦è¯„åˆ†
   â†“
   [StateTransitionNode]
   â”œâ”€ è¯„ä¼°å½“å‰çŠ¶æ€
   â””â”€ æ›´æ–°ä¼šè¯çŠ¶æ€
   â†“
   [SpecialIntentNode]
   â”œâ”€ æ£€æŸ¥ç‰¹æ®Šæ„å›¾
   â””â”€ æå‰è¿”å›ï¼ˆå¦‚æœåŒ¹é…ï¼‰
   â†“
   [FAQNode]
   â”œâ”€ æ£€æŸ¥ FAQ åŒ¹é…
   â””â”€ è¿”å› FAQ ç­”æ¡ˆï¼ˆå¦‚æœåŒ¹é…ï¼‰
   â†“
   [LLMNode]
   â”œâ”€ æ„å»º Prompt
   â”œâ”€ è°ƒç”¨ Gemini API
   â””â”€ å¤„ç†å“åº”
   â†“
   [ResponseNode]
   â”œâ”€ æ„å»ºæœ€ç»ˆå“åº”
   â”œâ”€ æ·»åŠ å¿«æ·å›å¤
   â””â”€ æ ¼å¼åŒ–è¾“å‡º
   â†“
5. ä¿å­˜æ•°æ®
   â”œâ”€ ä¿å­˜ä¼šè¯è®°å½•
   â”œâ”€ ä¿å­˜æ¶ˆæ¯è®°å½•
   â”œâ”€ æ›´æ–°æ€§èƒ½æŒ‡æ ‡
   â””â”€ æ›´æ–°æ„å›¾ç»Ÿè®¡
   â†“
6. è¿”å› JSON å“åº”
   {
     reply: "æ‚¨å¥½ï¼...",
     conversationId: "conv_123",
     quickReplies: [...]
   }
   â†“
7. Widget æ˜¾ç¤ºå›å¤
```

---

## éƒ¨ç½²æ¶æ„

### Cloudflare Pages æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Cloudflare Global Network         â”‚
â”‚  â€¢ 300+ æ•°æ®ä¸­å¿ƒ                          â”‚
â”‚  â€¢ è‡ªåŠ¨ HTTPS                             â”‚
â”‚  â€¢ DDoS é˜²æŠ¤                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Cloudflare Pages                  â”‚
â”‚  â€¢ é™æ€èµ„æºæ‰˜ç®¡                            â”‚
â”‚  â€¢ Functions (Serverless)                â”‚
â”‚  â€¢ è‡ªåŠ¨éƒ¨ç½²                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare  â”‚ Environment â”‚   Workers    â”‚
â”‚     D1      â”‚  Variables  â”‚     KV       â”‚
â”‚  (æ•°æ®åº“)   â”‚  (é…ç½®)     â”‚  (ç¼“å­˜)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¯å¢ƒé…ç½®

| ç¯å¢ƒ | URL | ç”¨é€” |
|------|-----|------|
| **å¼€å‘** | `localhost:8788` | æœ¬åœ°å¼€å‘ |
| **Staging** | `staging.pages.dev` | é¢„å‘å¸ƒæµ‹è¯• |
| **ç”Ÿäº§** | `chatbot-service-9qg.pages.dev` | ç”Ÿäº§ç¯å¢ƒ |

### CI/CD æµç¨‹

```
1. Git Push
   â†“
2. GitHub Actions è§¦å‘
   â”œâ”€ è¿è¡Œæµ‹è¯•
   â”œâ”€ ç±»å‹æ£€æŸ¥
   â””â”€ æ„å»º
   â†“
3. éƒ¨ç½²åˆ° Staging
   â”œâ”€ è‡ªåŠ¨éƒ¨ç½²
   â””â”€ å†’çƒŸæµ‹è¯•
   â†“
4. æ‰‹åŠ¨æ‰¹å‡†
   â†“
5. éƒ¨ç½²åˆ°ç”Ÿäº§
   â”œâ”€ é›¶åœæœºéƒ¨ç½²
   â”œâ”€ å¥åº·æ£€æŸ¥
   â””â”€ å›æ»šæœºåˆ¶
```

---

## å®‰å…¨æ€§

### 1. è®¤è¯å’Œæˆæƒ

- **API Key**: `GEMINI_API_KEY` ç¯å¢ƒå˜é‡
- **CORS**: ç™½åå•æœºåˆ¶ï¼ŒåŠ¨æ€æ¥æºéªŒè¯
- **Rate Limiting**: Cloudflare è‡ªåŠ¨é˜²æŠ¤

### 2. æ•°æ®å®‰å…¨

- **ä¼ è¾“åŠ å¯†**: HTTPS (TLS 1.3)
- **æ•°æ®éš”ç¦»**: å¤šç§Ÿæˆ·æ•°æ®åº“éš”ç¦»
- **è®¿é—®æ§åˆ¶**: åŸºäºå…¬å¸ ID çš„è®¿é—®æ§åˆ¶

### 3. å†…å®¹å®‰å…¨

- **è¾“å…¥éªŒè¯**: æ¶ˆæ¯é•¿åº¦ã€æ ¼å¼éªŒè¯
- **è¾“å‡ºè¿‡æ»¤**: XSS é˜²æŠ¤
- **æ•æ„Ÿä¿¡æ¯**: ä¸å­˜å‚¨æ•æ„Ÿæ•°æ®

### 4. å®‰å…¨æœ€ä½³å®è·µ

```typescript
// 1. ç¯å¢ƒå˜é‡ä¿æŠ¤
const apiKey = env.GEMINI_API_KEY;

// 2. CORS éªŒè¯
if (!isOriginAllowed(companyConfig, origin)) {
  return new Response('Forbidden', { status: 403 });
}

// 3. è¾“å…¥æ¸…ç†
const sanitizedMessage = sanitizeInput(message);

// 4. é”™è¯¯å¤„ç†
try {
  // ...
} catch (error) {
  // ä¸æ³„éœ²å†…éƒ¨é”™è¯¯ä¿¡æ¯
  return { error: 'Internal error' };
}
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. å“åº”æ—¶é—´ä¼˜åŒ–

| ä¼˜åŒ–æªæ–½ | æ•ˆæœ |
|---------|------|
| **Edge Computing** | å…¨çƒä½å»¶è¿Ÿ (< 50ms) |
| **å¹¶è¡ŒèŠ‚ç‚¹æ‰§è¡Œ** | å‡å°‘ 30% æ‰§è¡Œæ—¶é—´ |
| **çŸ¥è¯†åº“ç¼“å­˜** | é¿å…é‡å¤åŠ è½½ |
| **è¿æ¥æ± ç®¡ç†** | å¤ç”¨ HTTP è¿æ¥ |

### 2. æ•°æ®åº“ä¼˜åŒ–

```sql
-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_conversations_company ON conversations(company_id);
CREATE INDEX idx_messages_conversation ON messages(conversation_id);
CREATE INDEX idx_messages_timestamp ON messages(timestamp);

-- æŸ¥è¯¢ä¼˜åŒ–
SELECT * FROM messages 
WHERE conversation_id = ? 
ORDER BY timestamp DESC 
LIMIT 10;
```

### 3. ç¼“å­˜ç­–ç•¥

```
é™æ€èµ„æºç¼“å­˜:
- Widget JS: 1 å°æ—¶
- Widget CSS: 1 å°æ—¶
- çŸ¥è¯†åº“: 10 åˆ†é’Ÿ

åŠ¨æ€å†…å®¹:
- FAQ èœå•: 5 åˆ†é’Ÿ
- å…¬å¸é…ç½®: 10 åˆ†é’Ÿ
```

### 4. æ€§èƒ½ç›‘æ§

```typescript
// èŠ‚ç‚¹æ‰§è¡Œæ—¶é—´è¿½è¸ª
const startTime = Date.now();
await node.execute(context);
const duration = Date.now() - startTime;

// ä¿å­˜æ€§èƒ½æŒ‡æ ‡
await db.savePerformanceMetric({
  nodeId: node.id,
  executionTime: duration,
  timestamp: new Date(),
});
```

---

## ç›‘æ§å’Œè¿ç»´

### 1. æ—¥å¿—ç³»ç»Ÿ

```
[Scheduler] å®šæ—¶ä»»åŠ¡æ—¥å¿—
[Pipeline] å·¥ä½œæµæ‰§è¡Œæ—¥å¿—
[Database] æ•°æ®åº“æ“ä½œæ—¥å¿—
[API] API è¯·æ±‚æ—¥å¿—
[Error] é”™è¯¯æ—¥å¿—
```

### 2. æŒ‡æ ‡ç›‘æ§

- **è¯·æ±‚é‡**: æ¯å°æ—¶/æ¯å¤©è¯·æ±‚æ•°
- **å“åº”æ—¶é—´**: P50, P95, P99
- **é”™è¯¯ç‡**: 4xx, 5xx é”™è¯¯
- **API è°ƒç”¨**: Gemini API ä½¿ç”¨é‡

### 3. å‘Šè­¦æœºåˆ¶

```
é˜ˆå€¼å‘Šè­¦:
- é”™è¯¯ç‡ > 5%
- å“åº”æ—¶é—´ > 10 ç§’
- API é…é¢ > 80%

è‡ªåŠ¨æ¢å¤:
- é‡è¯•æœºåˆ¶
- é™çº§ç­–ç•¥
- ç†”æ–­å™¨
```

### 4. å®šæ—¶ä»»åŠ¡

| ä»»åŠ¡ | é¢‘ç‡ | ç”¨é€” |
|------|------|------|
| æ¸…ç†æ—§æ•°æ® | æ¯å¤© 2:00 | åˆ é™¤ 90 å¤©å‰æ•°æ® |
| ç”Ÿæˆç»Ÿè®¡ | æ¯å°æ—¶ | æ›´æ–°ç»Ÿè®¡æ•°æ® |
| ç”Ÿæˆå‘¨æŠ¥ | æ¯å‘¨ä¸€ 9:00 | ç”Ÿæˆåˆ†ææŠ¥å‘Š |
| æ•°æ®åº“ä¼˜åŒ– | æ¯å¤© 3:00 | ç»´æŠ¤å’Œä¼˜åŒ– |
| æ„å›¾ç»Ÿè®¡ | æ¯ 5 åˆ†é’Ÿ | æ›´æ–°å®æ—¶ç»Ÿè®¡ |

---

## æ‰©å±•æ€§

### 1. æ°´å¹³æ‰©å±•

- âœ… **æ— çŠ¶æ€è®¾è®¡**: æ‰€æœ‰è¯·æ±‚ç‹¬ç«‹
- âœ… **å…¨çƒåˆ†å¸ƒ**: Cloudflare è‡ªåŠ¨åˆ†å‘
- âœ… **è‡ªåŠ¨æ‰©å±•**: æ ¹æ®æµé‡è‡ªåŠ¨è°ƒæ•´

### 2. åŠŸèƒ½æ‰©å±•

#### æ·»åŠ æ–°å…¬å¸

```json
// knowledge/companies.json
{
  "newcompany": {
    "id": "newcompany",
    "name": "New Company",
    "allowedOrigins": ["https://newcompany.com"],
    "widgetConfig": { "theme": "light" }
  }
}
```

#### æ·»åŠ æ–°èŠ‚ç‚¹

```typescript
// functions/api/nodes-v3/custom/MyNode/index.ts
export class MyNode extends BaseNode {
  async execute(context: ExecutionContext) {
    // è‡ªå®šä¹‰é€»è¾‘
    return { success: true };
  }
}

// æ³¨å†ŒèŠ‚ç‚¹
NodeRegistry.register('my-node', MyNode);
```

### 3. é›†æˆæ‰©å±•

- **é‚®ä»¶æœåŠ¡**: SendGrid, Mailgun
- **æ¶ˆæ¯é˜Ÿåˆ—**: Cloudflare Queues
- **å­˜å‚¨æœåŠ¡**: R2 (å¯¹è±¡å­˜å‚¨)
- **åˆ†æå¹³å°**: Google Analytics, Mixpanel

---

## æœ€ä½³å®è·µ

### 1. ä»£ç ç»„ç»‡

```
functions/api/
â”œâ”€â”€ [company]/          # å¤šç§Ÿæˆ·è·¯ç”±
â”œâ”€â”€ pipeline-v3/        # Pipeline å¼•æ“
â”œâ”€â”€ nodes-v3/           # èŠ‚ç‚¹å®ç°
â”œâ”€â”€ workflows-v3/       # å·¥ä½œæµå®šä¹‰
â”œâ”€â”€ database/           # æ•°æ®ç®¡ç†
â”œâ”€â”€ scheduler/          # ä»»åŠ¡è°ƒåº¦
â””â”€â”€ lib/                # å…±äº«å·¥å…·
```

### 2. é”™è¯¯å¤„ç†

```typescript
try {
  // ä¸šåŠ¡é€»è¾‘
} catch (error) {
  console.error('[Component] Error:', error);
  
  // è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ
  await logError(error);
  
  // è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯
  return {
    error: 'æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨',
    code: 'SERVICE_ERROR',
  };
}
```

### 3. æµ‹è¯•ç­–ç•¥

```
æµ‹è¯•é‡‘å­—å¡”:

      /\
     /E2E\      10% - ç«¯åˆ°ç«¯æµ‹è¯•
    /â”€â”€â”€â”€â”€â”€\
   /Integration\  20% - é›†æˆæµ‹è¯•
  /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\
 /   Unit Tests  \  70% - å•å…ƒæµ‹è¯•
/â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\
```

### 4. æ–‡æ¡£ç»´æŠ¤

- âœ… README æ–‡ä»¶
- âœ… API æ–‡æ¡£
- âœ… æ¶æ„å›¾
- âœ… æ“ä½œæ‰‹å†Œ
- âœ… æ•…éšœæ’æŸ¥æŒ‡å—

---

## æ€»ç»“

### æ¶æ„ä¼˜åŠ¿

1. **äº‘åŸç”Ÿ**: å……åˆ†åˆ©ç”¨ Cloudflare å¹³å°èƒ½åŠ›
2. **å¯ç»´æŠ¤**: æ¸…æ™°çš„åˆ†å±‚å’Œæ¨¡å—åŒ–è®¾è®¡
3. **å¯æ‰©å±•**: çµæ´»çš„èŠ‚ç‚¹å’Œå·¥ä½œæµç³»ç»Ÿ
4. **å¯é æ€§**: å®Œæ•´çš„æµ‹è¯•å’Œç›‘æ§
5. **æ€§èƒ½**: å…¨çƒåˆ†å¸ƒå¼æ¶æ„

### æŠ€æœ¯å€ºåŠ¡

âš ï¸ **éœ€è¦æ”¹è¿›çš„åœ°æ–¹**:

1. æ·»åŠ ç¼“å­˜å±‚ (Redis/KV)
2. å®Œå–„é”™è¯¯æ¢å¤æœºåˆ¶
3. æ·»åŠ  A/B æµ‹è¯•æ”¯æŒ
4. å®ç°å®æ—¶ç›‘æ§ä»ªè¡¨æ¿

### æœªæ¥è§„åˆ’

ğŸ“… **ä¸‹ä¸€æ­¥è®¡åˆ’**:

1. æœºå™¨å­¦ä¹ å¢å¼º (ç”¨æˆ·è¡Œä¸ºé¢„æµ‹)
2. å¤šè¯­è¨€æ”¯æŒ
3. è¯­éŸ³æ¥å£
4. ç§»åŠ¨ SDK

---

**ç‰ˆæœ¬**: 3.0  
**æœ€åæ›´æ–°**: 2025-12-10  
**ç»´æŠ¤è€…**: chatbot-service Team  
**è¯„åˆ†**: 90+/100 (A)
