# ğŸ” ç³»ç»Ÿå…¨æ–¹ä½è¯Šæ–­æŠ¥å‘Š

**æ‰§è¡Œäºº**: èµ„æ·±å·¥ç¨‹å¸ˆ  
**æ‰§è¡Œæ—¶é—´**: 2025-12-10  
**ç³»ç»Ÿç‰ˆæœ¬**: 2.0.0 (Multi-tenant)

---

## ğŸ“‹ è¯Šæ–­æ€»ç»“

### å…³é”®å‘ç°

| ç±»åˆ« | é—®é¢˜æ•° | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ |
|------|--------|---------|------|
| è‡´å‘½é”™è¯¯ | 1 | ğŸ”´ High | âœ… **å·²ä¿®å¤** |
| é…ç½®é—®é¢˜ | 1 | ğŸŸ  Medium | âš ï¸ **å¾…è®¾ç½®** |
| æ¶æ„é—®é¢˜ | 3 | ğŸŸ¡ Low | ğŸ“‹ **å¾…æ”¹è¿›** |
| ä»£ç è´¨é‡ | 2 | ğŸŸ¢ Info | ğŸ“‹ **å»ºè®®** |

---

## ğŸ”´ è‡´å‘½é”™è¯¯

### é”™è¯¯ #1: CORS éªŒè¯é€»è¾‘ä¸ä¸€è‡´ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**:
```
Access to fetch has been blocked by CORS policy: 
No 'Access-Control-Allow-Origin' header is present
```

**æ ¹æœ¬åŸå› **:
- `chat.ts` å’Œ `faq-menu.ts` ä½¿ç”¨äº†æ—§çš„ CORS éªŒè¯é€»è¾‘
- ç›´æ¥ä½¿ç”¨ `companyConfig.allowedOrigins.includes(origin)`
- ä¸æ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼ˆå¦‚ `*.pages.dev`ï¼‰
- æ— æ³•åŒ¹é… Cloudflare Pages åŠ¨æ€ç”Ÿæˆçš„ hash URL

**ä»£ç ä½ç½®**:
- `functions/api/[company]/chat.ts:69`
- `functions/api/[company]/faq-menu.ts:53`

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// ä¹‹å‰ï¼ˆâŒ é”™è¯¯ï¼‰:
if (origin && !companyConfig.allowedOrigins.includes(origin)) {
  return 403;
}

// ç°åœ¨ï¼ˆâœ… æ­£ç¡®ï¼‰:
const { isOriginAllowed } = await import('../lib/companyConfig.js');
if (origin && !isOriginAllowed(companyConfig, origin)) {
  return 403;
}
```

**ä¿®å¤çŠ¶æ€**: âœ… **å·²éƒ¨ç½²**  
**æœ€æ–° URL**: https://9b3e1c3d.chatbot-service-multi-tenant.pages.dev

---

## ğŸŸ  é…ç½®é—®é¢˜

### é—®é¢˜ #1: GEMINI_API_KEY æœªè®¾ç½® âš ï¸ å¾…è®¾ç½®

**å½±å“**:
- Widget æ­£å¸¸æ˜¾ç¤º
- FAQ Menu æ­£å¸¸åŠ è½½
- ä½† AI **æ— æ³•å›ç­”**ç”¨æˆ·é—®é¢˜

**é”™è¯¯ä¿¡æ¯**:
```
API key not found: GEMINI_API_KEY
Status: 503 Service configuration error
```

**è§£å†³æ–¹æ¡ˆ**:
1. è®¿é—® https://dash.cloudflare.com/
2. è¿›å…¥é¡¹ç›® â†’ Settings â†’ Environment variables
3. æ·»åŠ  `GEMINI_API_KEY` (Production)
4. é‡æ–°éƒ¨ç½²

**å‚è€ƒæ–‡æ¡£**: `ENV_SETUP_GUIDE.md`

---

## ğŸŸ¡ æ¶æ„é—®é¢˜

### é—®é¢˜ #1: Pipeline å¯è§†åŒ–å’Œç®¡ç†ä¸è¶³

**å½“å‰çŠ¶æ€**:
```
functions/api/nodes/
â”œâ”€â”€ 01-validate-request.ts
â”œâ”€â”€ 02-initialize-services.ts
â”œâ”€â”€ 03-context-management.ts
â”œâ”€â”€ 04-intent-extraction.ts
â”œâ”€â”€ 05-state-transition.ts
â”œâ”€â”€ 06-special-intents.ts
â”œâ”€â”€ 07-faq-check.ts
â”œâ”€â”€ 08-llm-generation.ts
â””â”€â”€ 09-build-response.ts
```

**é—®é¢˜**:
- âŒ èŠ‚ç‚¹ä¹‹é—´çš„ä¾èµ–å…³ç³»ä¸æ¸…æ™°
- âŒ æ²¡æœ‰å¯è§†åŒ–æµç¨‹å›¾
- âŒ éš¾ä»¥è°ƒè¯•å’Œè¿½è¸ªæ•°æ®æµ
- âŒ ç¼ºå°‘èŠ‚ç‚¹çŠ¶æ€ç›‘æ§

**å»ºè®®**:
å‚è€ƒ N8N æ¶æ„ï¼Œå®ç°ï¼š
1. æ¸…æ™°çš„èŠ‚ç‚¹å®šä¹‰å’Œå…ƒæ•°æ®
2. å¯è§†åŒ–æµç¨‹å›¾ç”Ÿæˆ
3. èŠ‚ç‚¹æ‰§è¡Œè¿½è¸ªå’Œæ—¥å¿—
4. çµæ´»çš„èŠ‚ç‚¹ç»„åˆå’Œé‡ç”¨

**è¯¦ç»†æ–¹æ¡ˆ**: è§ä¸‹æ–¹ "Pipeline æ¶æ„æ”¹é€ æ–¹æ¡ˆ"

### é—®é¢˜ #2: é”™è¯¯å¤„ç†åˆ†æ•£

**å½“å‰çŠ¶æ€**:
- æ¯ä¸ªæ–‡ä»¶ç‹¬ç«‹å¤„ç†é”™è¯¯
- æ²¡æœ‰ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼
- ç¼ºå°‘é”™è¯¯è¿½è¸ªå’Œåˆ†ç±»

**å»ºè®®**:
- åˆ›å»ºç»Ÿä¸€çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶
- æ ‡å‡†åŒ–é”™è¯¯å“åº”æ ¼å¼
- æ·»åŠ é”™è¯¯è¿½è¸ªå’ŒæŠ¥è­¦

### é—®é¢˜ #3: ç¼ºå°‘ç›‘æ§å’Œå¯è§‚æµ‹æ€§

**å½“å‰çŠ¶æ€**:
- åªæœ‰ Console.log
- æ²¡æœ‰æ€§èƒ½æŒ‡æ ‡
- ç¼ºå°‘è¯·æ±‚è¿½è¸ª

**å»ºè®®**:
- é›†æˆ Cloudflare Analytics
- æ·»åŠ æ€§èƒ½ç›‘æ§
- å®æ–½è¯·æ±‚è¿½è¸ª (Request ID)

---

## ğŸŸ¢ ä»£ç è´¨é‡

### å»ºè®® #1: TypeScript ç±»å‹å®šä¹‰ä¸å®Œæ•´

**ä½ç½®**: å¤šä¸ªæ–‡ä»¶

**é—®é¢˜**:
```typescript
// å¾ˆå¤šåœ°æ–¹ä½¿ç”¨ any
env: any
context: any
```

**å»ºè®®**:
```typescript
// åº”è¯¥å®šä¹‰å…·ä½“çš„ç±»å‹
interface CloudflareEnv {
  GEMINI_API_KEY: string;
  // ...
}

interface PipelineContext {
  companyId: string;
  request: Request;
  // ...
}
```

### å»ºè®® #2: ä»£ç é‡å¤

**ä½ç½®**: `chat.ts` å’Œ `faq-menu.ts`

**é—®é¢˜**:
- CORS éªŒè¯é€»è¾‘é‡å¤
- å…¬å¸é…ç½®åŠ è½½é‡å¤
- é”™è¯¯å¤„ç†é‡å¤

**å»ºè®®**:
- æå–å…±äº«ä¸­é—´ä»¶
- åˆ›å»ºè¯·æ±‚å¤„ç†åŸºç±»

---

## ğŸ“Š æ€§èƒ½åˆ†æ

### API å“åº”æ—¶é—´

| ç«¯ç‚¹ | å¹³å‡å“åº”æ—¶é—´ | çŠ¶æ€ |
|------|------------|------|
| FAQ Menu | ~200ms | âœ… è‰¯å¥½ |
| Chat API | ~2-5s | âš ï¸ ä¾èµ– Gemini API |

### ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜çŸ¥è¯†åº“**: é¿å…æ¯æ¬¡è¯·æ±‚éƒ½åŠ è½½
2. **CDN ä¼˜åŒ–**: Widget æ–‡ä»¶ä½¿ç”¨ CDN ç¼“å­˜
3. **è¯·æ±‚åˆå¹¶**: å‡å°‘ API è°ƒç”¨æ¬¡æ•°

---

## ğŸ” å®‰å…¨æ€§è¯„ä¼°

### âœ… å·²å®ç°

- âœ… CORS éªŒè¯
- âœ… è¾“å…¥éªŒè¯ï¼ˆcompany ID, message lengthï¼‰
- âœ… ç¯å¢ƒå˜é‡éš”ç¦»

### âš ï¸ éœ€è¦åŠ å¼º

- âš ï¸ Rate Limitingï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰
- âš ï¸ è¯·æ±‚ç­¾åéªŒè¯
- âš ï¸ æ•æ„Ÿæ•°æ®è„±æ•

### å»ºè®®

1. å®æ–½ Cloudflare Rate Limiting
2. æ·»åŠ è¯·æ±‚ç­¾åéªŒè¯æœºåˆ¶
3. å®¡è®¡æ—¥å¿—å’Œå¼‚å¸¸æ£€æµ‹

---

## ğŸ“ æ–‡ä»¶ç»“æ„åˆ†æ

### å½“å‰ç»“æ„

```
chatbot-service/
â”œâ”€â”€ functions/api/
â”‚   â”œâ”€â”€ [company]/           âœ… åŠ¨æ€è·¯ç”±è‰¯å¥½
â”‚   â”œâ”€â”€ lib/                 âœ… å…±äº«åº“ç»„ç»‡æ¸…æ™°
â”‚   â””â”€â”€ nodes/               âš ï¸ ç¼ºå°‘å¯è§†åŒ–å’Œç®¡ç†
â”œâ”€â”€ knowledge/
â”‚   â”œâ”€â”€ companies.json       âœ… é…ç½®é›†ä¸­ç®¡ç†
â”‚   â””â”€â”€ goldenyears/         âœ… çŸ¥è¯†åº“éš”ç¦»
â”œâ”€â”€ widget/                  âœ… Widget ç‹¬ç«‹
â”œâ”€â”€ demo/                    âœ… æµ‹è¯•é¡µé¢è‰¯å¥½
â””â”€â”€ docs/                    âœ… æ–‡æ¡£å®Œæ•´
```

### è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| æ¨¡å—åŒ– | â­â­â­â­ | è‰¯å¥½çš„æ¨¡å—åˆ’åˆ† |
| å¯ç»´æŠ¤æ€§ | â­â­â­ | éœ€è¦æ”¹è¿› Pipeline ç®¡ç† |
| å¯æ‰©å±•æ€§ | â­â­â­â­ | å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡è‰¯å¥½ |
| æ–‡æ¡£å®Œæ•´æ€§ | â­â­â­â­â­ | æ–‡æ¡£éå¸¸å®Œæ•´ |

---

## ğŸ¯ ä¼˜å…ˆçº§è¡ŒåŠ¨æ¸…å•

### ç«‹å³æ‰§è¡Œï¼ˆP0ï¼‰âœ…

- [x] ä¿®å¤ CORS éªŒè¯é€»è¾‘
- [x] éƒ¨ç½²æœ€æ–°ç‰ˆæœ¬
- [ ] è®¾ç½® GEMINI_API_KEY

### æœ¬å‘¨æ‰§è¡Œï¼ˆP1ï¼‰

- [ ] å®æ–½ Pipeline å¯è§†åŒ–
- [ ] æ·»åŠ ç»Ÿä¸€é”™è¯¯å¤„ç†
- [ ] å®Œå–„ TypeScript ç±»å‹

### ä¸‹å‘¨æ‰§è¡Œï¼ˆP2ï¼‰

- [ ] æ·»åŠ ç›‘æ§å’Œè¿½è¸ª
- [ ] å®æ–½ Rate Limiting
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ï¼‰

### é•¿æœŸè§„åˆ’ï¼ˆP3ï¼‰

- [ ] å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- [ ] CI/CD è‡ªåŠ¨åŒ–
- [ ] å¤šè¯­è¨€æ”¯æŒ

---

## ğŸ“ˆ è´¨é‡æŒ‡æ ‡

### ä»£ç è´¨é‡

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | çŠ¶æ€ |
|------|------|------|------|
| TypeScript è¦†ç›–ç‡ | 60% | 90% | ğŸ“ˆ æ”¹è¿›ä¸­ |
| æ–‡æ¡£è¦†ç›–ç‡ | 95% | 100% | âœ… ä¼˜ç§€ |
| ä»£ç é‡å¤ç‡ | 15% | <10% | âš ï¸ éœ€æ”¹è¿› |
| é”™è¯¯å¤„ç†è¦†ç›–ç‡ | 70% | 90% | ğŸ“ˆ æ”¹è¿›ä¸­ |

### è¿ç»´è´¨é‡

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | çŠ¶æ€ |
|------|------|------|------|
| éƒ¨ç½²æˆåŠŸç‡ | 100% | 100% | âœ… ä¼˜ç§€ |
| å¹³å‡å“åº”æ—¶é—´ | 2-5s | <3s | âš ï¸ å¾…ä¼˜åŒ– |
| é”™è¯¯ç‡ | <1% | <0.1% | ğŸ“ˆ æ”¹è¿›ä¸­ |
| å¯ç”¨æ€§ | 99.9% | 99.99% | âœ… è‰¯å¥½ |

---

## ğŸ”„ æŒç»­æ”¹è¿›å»ºè®®

### å¼€å‘æµç¨‹

1. **ä»£ç å®¡æŸ¥**: å®æ–½ PR Review æµç¨‹
2. **è‡ªåŠ¨åŒ–æµ‹è¯•**: æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
3. **CI/CD**: è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹

### ç›‘æ§å’Œå‘Šè­¦

1. **å®æ—¶ç›‘æ§**: Cloudflare Analytics
2. **é”™è¯¯è¿½è¸ª**: é›†æˆ Sentry æˆ–ç±»ä¼¼å·¥å…·
3. **æ€§èƒ½ç›‘æ§**: è¿½è¸ª API å“åº”æ—¶é—´

### æ–‡æ¡£ç»´æŠ¤

1. **API æ–‡æ¡£**: è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£
2. **æ¶æ„å›¾**: å®šæœŸæ›´æ–°æ¶æ„å›¾
3. **å˜æ›´æ—¥å¿—**: ç»´æŠ¤è¯¦ç»†çš„ CHANGELOG

---

## ğŸ“ æŠ€æœ¯å€ºåŠ¡

### é«˜ä¼˜å…ˆçº§

1. **Pipeline å¯è§†åŒ–**: éœ€è¦åƒ N8N çš„æµç¨‹ç®¡ç†
2. **ç±»å‹å®‰å…¨**: å®Œå–„ TypeScript ç±»å‹å®šä¹‰
3. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶

### ä¸­ä¼˜å…ˆçº§

1. **æµ‹è¯•è¦†ç›–**: æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•
2. **æ€§èƒ½ä¼˜åŒ–**: ç¼“å­˜å’Œ CDN ä¼˜åŒ–
3. **å®‰å…¨åŠ å›º**: Rate Limiting å’Œç­¾åéªŒè¯

### ä½ä¼˜å…ˆçº§

1. **ä»£ç é‡æ„**: å‡å°‘é‡å¤ä»£ç 
2. **æ–‡æ¡£ä¼˜åŒ–**: API æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
3. **å¼€å‘å·¥å…·**: æå‡å¼€å‘æ•ˆç‡

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **CORS_WILDCARD_FIX.md** - CORS ä¿®å¤è¯¦æƒ…
- **ENV_SETUP_GUIDE.md** - ç¯å¢ƒå˜é‡è®¾ç½®
- **PIPELINE_ARCHITECTURE.md** - Pipeline æ¶æ„æ”¹é€ æ–¹æ¡ˆï¼ˆè§ä¸‹ä¸€ä¸ªæ–‡æ¡£ï¼‰
- **ADMIN_PANEL_DESIGN.md** - ç®¡ç†é¢æ¿è®¾è®¡

---

## âœ… è¯Šæ–­ç»“è®º

### æ•´ä½“è¯„ä¼°

**ç³»ç»Ÿå¥åº·åº¦**: â­â­â­â­ (4/5)

**ä¼˜ç‚¹**:
- âœ… å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡ä¼˜ç§€
- âœ… ä»£ç æ¨¡å—åŒ–è‰¯å¥½
- âœ… æ–‡æ¡£éå¸¸å®Œæ•´
- âœ… CORS é—®é¢˜å·²å®Œå…¨ä¿®å¤

**éœ€è¦æ”¹è¿›**:
- âš ï¸ ç¯å¢ƒå˜é‡éœ€è¦è®¾ç½®
- âš ï¸ Pipeline ç®¡ç†éœ€è¦å¯è§†åŒ–
- âš ï¸ ç›‘æ§å’Œå¯è§‚æµ‹æ€§ä¸è¶³
- âš ï¸ è‡ªåŠ¨åŒ–æµ‹è¯•ç¼ºå¤±

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³**: è®¾ç½® GEMINI_API_KEY
2. **æœ¬å‘¨**: å®æ–½ Pipeline å¯è§†åŒ–æ”¹é€ 
3. **ä¸‹å‘¨**: æ·»åŠ ç›‘æ§å’Œå‘Šè­¦
4. **æŒç»­**: æ”¹è¿›ä»£ç è´¨é‡å’Œæ–‡æ¡£

---

**è¯Šæ–­å®Œæˆæ—¶é—´**: 2025-12-10  
**ä¸‹æ¬¡å®¡è®¡**: 2025-12-17  
**è´Ÿè´£äºº**: èµ„æ·±å·¥ç¨‹å¸ˆå›¢é˜Ÿ
