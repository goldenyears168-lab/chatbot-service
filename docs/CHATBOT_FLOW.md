# 聊天机器人流程说明

## 当前实现逻辑

### 流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户交互入口                               │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│  初始菜单点击  │   │ 预测问题点击  │   │   手动输入    │
│ (FAQ Menu)   │   │(Suggested)   │   │ (Input Box)  │
└──────────────┘   └──────────────┘   └──────────────┘
        │                   │                   │
        └───────────────────┴───────────────────┘
                            │
                            ▼
                ┌───────────────────────┐
                │  findFAQAnswer()      │
                │  在 FAQ 中查找答案      │
                │  支持 4 种匹配方式：    │
                │  1. 精确匹配           │
                │  2. 标准化匹配         │
                │  3. 关键词匹配         │
                │  4. 子串匹配           │
                └───────────────────────┘
                            │
            ┌───────────────┴───────────────┐
            │                               │
            ▼                               ▼
    ┌───────────────┐             ┌───────────────┐
    │   找到 FAQ     │             │  未找到 FAQ    │
    │   答案         │             │  答案          │
    └───────────────┘             └───────────────┘
            │                               │
            ▼                               ▼
    ┌───────────────┐   ┌───────────────────────────────┐
    │ 直接显示答案    │   │  菜单/预测问题：显示错误消息    │
    │ (setMessages)  │   │  手动输入：调用 AI API         │
    │ ❌ 不调用 API   │   │  (sendMessage)                │
    └───────────────┘   │  ✅ 仅手动输入时调用 API        │
                        └───────────────────────────────┘
            │                               │
            └───────────────┬───────────────┘
                            │
                            ▼
                ┌───────────────────────┐
                │  显示答案 + 预测问题    │
                │  (next_best_actions)   │
                └───────────────────────┘
```

## 详细说明

### 1. 初始菜单点击（FAQ Menu）

**触发场景**：用户点击欢迎页面的 FAQ 菜单项

**处理流程**：
```
用户点击菜单项
  → handleFAQQuestionClick(question)
  → findFAQAnswer(question)  // 在 5-faq_detailed.json 中查找
  → 如果找到：
      → 直接显示答案（setMessages）
      → ❌ 不调用 API
  → 如果未找到（不应该发生，可能是配置错误）：
      → 显示错误提示消息
      → ❌ 不调用 API（已优化，移除 AI 兜底）
```

### 2. 预测问题点击（Suggested Questions）

**触发场景**：用户点击 AI 回复下方的预测问题按钮

**处理流程**：
```
用户点击预测问题
  → handleFAQQuestionClick(question)  // 使用相同的处理函数
  → findFAQAnswer(question)  // 在 5-faq_detailed.json 中查找
  → 如果找到：
      → 直接显示答案（setMessages）
      → ❌ 不调用 API
  → 如果未找到（不应该发生，可能是配置错误）：
      → 显示错误提示消息
      → ❌ 不调用 API（已优化，移除 AI 兜底）
```

### 3. 手动输入（Input Box）

**触发场景**：用户在输入框中手动输入问题

**处理流程**：
```
用户手动输入问题
  → handleSubmit(messageText)
  → findFAQAnswer(messageText)  // 先尝试在 FAQ 中查找
  → 如果找到：
      → 直接显示答案（setMessages）
      → ❌ 不调用 API
  → 如果未找到：
      → 调用 AI API（sendMessage）
      → ✅ 调用 API
```

## API 调用情况总结

| 场景 | 是否调用 API | 说明 |
|------|------------|------|
| 初始菜单点击（FAQ Menu） | ❌ **永远不调用** | 所有菜单项都在 FAQ 中，直接显示答案。如果找不到，显示错误消息但不调用 API |
| 预测问题点击（Suggested） | ❌ **永远不调用** | 所有预测问题都在 FAQ 中，直接显示答案。如果找不到，显示错误消息但不调用 API |
| 手动输入（在 FAQ 中） | ❌ 不调用 | 如果输入的问题匹配 FAQ，直接显示答案 |
| 手动输入（不在 FAQ 中） | ✅ **调用** | **只有这种情况会调用 AI API** |

## 已完成的优化

### ✅ 1. 移除菜单点击的 AI 兜底

**已优化**：菜单项和预测问题点击现在永远不调用 API，即使找不到 FAQ 答案，也只显示错误消息。

```typescript
// 优化后的代码
} else {
  // 菜单项或预测问题应该在 FAQ 中，如果找不到，记录错误但不调用 AI
  clientLogger.error('FAQ question not found in menu/suggested questions', { 
    question,
    availableCategories: faqMenu ? Object.keys(faqMenu.categories || {}) : []
  })
  // 显示错误提示给用户，但不调用 AI API
  setMessages([...messages, errorMessage])
}
```

## 未来优化建议

### 1. 改进匹配逻辑

可以考虑：
- 关键词匹配（如果用户输入包含 FAQ 问题的关键词）
- 模糊匹配（使用编辑距离算法）
- 同义词匹配

### 2. 增强错误处理

- 当菜单项或预测问题找不到时，可以提供更友好的错误提示
- 可以建议用户尝试其他相关问题

## 总结

**当前状态（已优化）**：
- ✅ **菜单点击**：**永远不调用 API**（已优化，移除 AI 兜底）
- ✅ **预测问题点击**：**永远不调用 API**（已优化，移除 AI 兜底）
- ✅ **手动输入**：先查找 FAQ，找不到才调用 API

**结论**：
- ✅ **菜单和预测问题点击**：已完全实现不调用 API
- ✅ **手动输入**：智能路由，先查找 FAQ，找不到才调用 AI API
- ✅ **API 调用最小化**：只有在用户手动输入且不在 FAQ 中的问题时，才会调用 AI API
- ✅ **匹配逻辑增强**：支持 4 种匹配方式，提高匹配成功率，减少不必要的 API 调用

## 最新改进（2025-01-20）

### 增强的 FAQ 匹配逻辑

为了提高匹配成功率，减少不必要的 API 调用，我们增强了 `findFAQAnswer` 函数的匹配逻辑：

1. **精确匹配**：完全相同的文本
2. **标准化匹配**：去除标点、空格、转小写后匹配
3. **关键词匹配**：提取关键词，如果匹配的关键词数量 >= 阈值，则匹配成功
4. **子串匹配**：检查是否包含 FAQ 问题的完整文本（作为子串）

详细说明请参考：`docs/FAQ_MATCHING_IMPROVEMENTS.md`

